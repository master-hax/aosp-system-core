{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "c9886e6b_049b75de",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 4
      },
      "lineNbr": 0,
      "author": {
        "id": 1724998
      },
      "writtenOn": "2021-03-10T08:02:05Z",
      "side": 1,
      "message": "Re-factored code to add in new worker thread class; This change set looks big but it is mostly\nre-structuring of snapuserd.cpp; all the worker thread related functions have been moved to snapuserd_worker.cpp.\n\nThere is no change in the IO path - To make the review easy:\n\n1: Start from Snapuserd::Start() - which is the entry point to launch worker threads\n2: Snapuserd.h has the new worker class\n3: Snapuserd_worker.cpp has all the IO path related code - No major changes here apart from the addition of new function RunThread()",
      "revId": "8f0840940e088fc938c51c2d6bb54b4fd50adbb6",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "b4e15eb3_3f32577d",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 4
      },
      "lineNbr": 0,
      "author": {
        "id": 1290458
      },
      "writtenOn": "2021-03-11T00:33:12Z",
      "side": 1,
      "message": "This is a great refactoring - glad to see we don\u0027t need the thread id vectors at all anymore.",
      "revId": "8f0840940e088fc938c51c2d6bb54b4fd50adbb6",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "53b7e856_cde18567",
        "filename": "fs_mgr/libsnapshot/snapuserd.h",
        "patchSetId": 4
      },
      "lineNbr": 129,
      "author": {
        "id": 1290458
      },
      "writtenOn": "2021-03-11T00:33:12Z",
      "side": 1,
      "message": "It\u0027s pretty expensive to open readers - do we want to make this a shared_ptr too?",
      "revId": "8f0840940e088fc938c51c2d6bb54b4fd50adbb6",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "ba32278a_0a9544f6",
        "filename": "fs_mgr/libsnapshot/snapuserd.h",
        "patchSetId": 4
      },
      "lineNbr": 129,
      "author": {
        "id": 1724998
      },
      "writtenOn": "2021-03-11T00:48:40Z",
      "side": 1,
      "message": "No - we can\u0027t make this shared_ptr; each thread has to have a separate COW fd handle as each thread will be reading COW device based on the IO request. If we make this shared, then we will have to synchronize the threads.\n\nAlso, it is not expensive to open readers because, each thread will just open the COW fd and store the handle. They will not read all the ops - This is the reason why I added a new function in cow_reader.cpp (InitForMerge()); this will not call Parseops(). The main thread when reading metadata will call ParseOps().\n\nWhen merge is being done, we will update the \"reader\" of the main thread in CommitMerge(). That is the only place we have lock; we actually don\u0027t need lock as the merge is single threaded but in theory multiple threads can be updating it if merge algorithm in kernel is parallelized.",
      "parentUuid": "53b7e856_cde18567",
      "revId": "8f0840940e088fc938c51c2d6bb54b4fd50adbb6",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}