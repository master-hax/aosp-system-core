{
  "comments": [
    {
      "key": {
        "uuid": "59428fb5_c04631e4",
        "filename": "adb/client/adb_install.cpp",
        "patchSetId": 3
      },
      "lineNbr": 45,
      "author": {
        "id": 1003224
      },
      "writtenOn": "2018-10-12T15:38:37Z",
      "side": 1,
      "message": "why not just do this now? note also that bionic\u0027s \u003candroid/api-level.h\u003e already has constants like __ANDROID_API_Q__ that you can use. (and if Q _isn\u0027t_ 29, it\u0027ll be fixed there, for everyone.)",
      "revId": "dbcef7e00bce01082f83cc92caf978b78ec86d15",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "8c58d033_b1777915",
        "filename": "adb/client/adb_install.cpp",
        "patchSetId": 3
      },
      "lineNbr": 45,
      "author": {
        "id": 1305591
      },
      "writtenOn": "2018-10-15T12:27:15Z",
      "side": 1,
      "message": "I tried using bionic\u0027s constants but I guess I should add a dependency on bionic which I don\u0027t think it\u0027s what you are suggesting.\n\nBTW __ANDROID_API_Q__ is already set to 29. The problem here is that if you build the OS from HEAD (aosp or internal) as of today the device will still report being API level 28 (as per get_device_api_level()). I have been explained that the API bump in the build system will only happen at release time. Since I want developers to use ADB to start testing .apex packages using internal builds, it feels OK to have this in place for now. The alternative would be to ask developers to hack their builds by e.g. by setting PLATFORM_VERSION_SDK manually in their environment.",
      "parentUuid": "59428fb5_c04631e4",
      "revId": "dbcef7e00bce01082f83cc92caf978b78ec86d15",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "bd57e565_326a21fd",
        "filename": "adb/client/adb_install.cpp",
        "patchSetId": 3
      },
      "lineNbr": 45,
      "author": {
        "id": 1003224
      },
      "writtenOn": "2018-10-15T16:03:16Z",
      "side": 1,
      "message": "ah, sorry, forgot that this was host-side code.\n\nfor stuff like this, what we usually do is...",
      "parentUuid": "8c58d033_b1777915",
      "revId": "dbcef7e00bce01082f83cc92caf978b78ec86d15",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "da502c4e_78c02fe8",
        "filename": "adb/client/adb_install.cpp",
        "patchSetId": 3
      },
      "lineNbr": 57,
      "author": {
        "id": 1003224
      },
      "writtenOn": "2018-10-15T16:03:16Z",
      "side": 1,
      "message": "...something like this. so the adbd can report whether or not it supports something.",
      "range": {
        "startLine": 49,
        "startChar": 0,
        "endLine": 57,
        "endChar": 1
      },
      "revId": "dbcef7e00bce01082f83cc92caf978b78ec86d15",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "df408694_4069effc",
        "filename": "adb/client/adb_install.cpp",
        "patchSetId": 3
      },
      "lineNbr": 57,
      "author": {
        "id": 1305591
      },
      "writtenOn": "2018-10-16T09:53:42Z",
      "side": 1,
      "message": "I believe the API level check would be more accurate. The feature really needs to be supported by PM and not by adb. The way the adb install flow is designed, it seems to me, is to just be a proxy of cmd, intercepted on packagemanager side by PackageManagerShellCommand. Therefore, whether apex is supported or not does not depend on adbd on the phone side.\n\nNote also that, assuming that I do the change you request and I add a new adb feature, we would be exactly in the same situation on an AOSP build as we are with API-level check, i.e. we\u0027d assume that the phone supports the feature because adbd says so, but in reality the AOSP version of API doesn\u0027t still have support for the feature and will fail, outputin.\n\nI cc\u0027d you to the WIP internal change on the PM side, id I3ac7971ce6923511a7d574291fe9002c5d55fa1b .",
      "parentUuid": "da502c4e_78c02fe8",
      "range": {
        "startLine": 49,
        "startChar": 0,
        "endLine": 57,
        "endChar": 1
      },
      "revId": "dbcef7e00bce01082f83cc92caf978b78ec86d15",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "f64d02d6_fa2f3e88",
        "filename": "adb/client/adb_install.cpp",
        "patchSetId": 3
      },
      "lineNbr": 57,
      "author": {
        "id": 1079148
      },
      "writtenOn": "2018-10-16T20:38:32Z",
      "side": 1,
      "message": "The API level check doesn\u0027t seem quite right to me. Can we do the packagemanager change in aosp? If not, adding the feature flag check here, and marking adbd as having the feature in internal seems like a better way of doing it.",
      "parentUuid": "df408694_4069effc",
      "range": {
        "startLine": 49,
        "startChar": 0,
        "endLine": 57,
        "endChar": 1
      },
      "revId": "dbcef7e00bce01082f83cc92caf978b78ec86d15",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "4abe02c5_5ae0f33d",
        "filename": "adb/client/adb_install.cpp",
        "patchSetId": 3
      },
      "lineNbr": 57,
      "author": {
        "id": 1305591
      },
      "writtenOn": "2018-10-18T15:25:44Z",
      "side": 1,
      "message": "PackageManager change in aosp would be quite burdensome to maintain, since the install flow is going to change and evolve (also b/c of apex) and we\u0027ll have t keep just a basic version in aosp ensuring that it works. Things might also change in the PackageManager flow as work on APEX+APK updates evolve.\n\nHow do you mark adbd as having the feature only in internal? Trying to guess what you mean, I thought you meant to add an available feature kFeatureApex to transport.h/cpp, but only add it to supported_features() (still transport.cpp) in the internal version of adb.\n\nMaybe that\u0027s not what you meant, because my tests were unsuccessful. Calling the two versions of adb binary as described above Y (with kFeatureApex \\in supported_features) and N (otherwise):\n\n- I compiled version Y of adb and flashed it on the phone\n- I ran adb (version Y) kill-server + start-server from host command line\n- I ran adb (version N) install file.apex from host command line\n\nAnd it failed the install saying that the feature is not supported on the server.\n\nI guess I don\u0027t fully understand the adb architecture here.",
      "parentUuid": "f64d02d6_fa2f3e88",
      "range": {
        "startLine": 49,
        "startChar": 0,
        "endLine": 57,
        "endChar": 1
      },
      "revId": "dbcef7e00bce01082f83cc92caf978b78ec86d15",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "1dc56d75_82d9e6dc",
        "filename": "adb/client/adb_install.cpp",
        "patchSetId": 3
      },
      "lineNbr": 57,
      "author": {
        "id": 1003224
      },
      "writtenOn": "2018-10-19T01:13:00Z",
      "side": 1,
      "message": "\u003e PackageManager change in aosp would be quite burdensome to maintain\n\ni thought the rest of the work was happening in AOSP? won\u0027t the ART folks need this in AOSP? i thought someone in LON already cherrypicked out changes to get AOSP and internal in sync for this?\n\n\u003e my tests were unsuccessful\n\n`adb devices -l` will show you the claimed features for debugging.",
      "parentUuid": "4abe02c5_5ae0f33d",
      "range": {
        "startLine": 49,
        "startChar": 0,
        "endLine": 57,
        "endChar": 1
      },
      "revId": "dbcef7e00bce01082f83cc92caf978b78ec86d15",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "00507d48_d3700bf6",
        "filename": "adb/client/adb_install.cpp",
        "patchSetId": 3
      },
      "lineNbr": 57,
      "author": {
        "id": 1305591
      },
      "writtenOn": "2018-10-19T13:23:01Z",
      "side": 1,
      "message": "\u003e i thought the rest of the work was happening in AOSP? won\u0027t the ART folks need this in AOSP? i thought someone in LON already cherrypicked out changes to get AOSP and internal in sync for this?\n\nI can discuss with toddke@ whether I should do the PackageManager changes in AOSP first. My only concern is doubling the maintainance burden but I agree it would make sense.\n\n\u003e `adb devices -l` will show you the claimed features for debugging.\n\nThanks, I had to use `adb features` and it was helpful.\n\nIf you agree, I\u0027d submit the support on ADB AOSP for now, assuming that a AOSP build will support APEX. This means that attempting the install would fail early on devices that already shipped with P because the feature is missing from adbd, and on development build it will fail with a PackageManager error (which is readable).\n\nI\u0027ll discuss with the frameworks team about integrating PM changes to AOSP early. I\u0027m happy to do that unless they disagree for any reason.",
      "parentUuid": "1dc56d75_82d9e6dc",
      "range": {
        "startLine": 49,
        "startChar": 0,
        "endLine": 57,
        "endChar": 1
      },
      "revId": "dbcef7e00bce01082f83cc92caf978b78ec86d15",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "5699c1e6_cf8a35a5",
        "filename": "adb/client/adb_install.cpp",
        "patchSetId": 3
      },
      "lineNbr": 155,
      "author": {
        "id": 1003224
      },
      "writtenOn": "2018-10-12T15:38:37Z",
      "side": 1,
      "message": "yeah, prefer fatal() for these rather than making people think about whether the caller does the right thing.",
      "revId": "dbcef7e00bce01082f83cc92caf978b78ec86d15",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "b3144c78_8eaba0dc",
        "filename": "adb/client/adb_install.cpp",
        "patchSetId": 3
      },
      "lineNbr": 155,
      "author": {
        "id": 1305591
      },
      "writtenOn": "2018-10-15T12:27:15Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "5699c1e6_cf8a35a5",
      "revId": "dbcef7e00bce01082f83cc92caf978b78ec86d15",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "3aee65c5_f5dc9e4c",
        "filename": "adb/client/adb_install.cpp",
        "patchSetId": 3
      },
      "lineNbr": 157,
      "author": {
        "id": 1003224
      },
      "writtenOn": "2018-10-12T15:38:37Z",
      "side": 1,
      "message": "prefer to say both what you got and what you expected in errors. \".apex requires API level %d (device is %d)\" is both shorter and more useful.",
      "range": {
        "startLine": 156,
        "startChar": 17,
        "endLine": 157,
        "endChar": 41
      },
      "revId": "dbcef7e00bce01082f83cc92caf978b78ec86d15",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "e82c7285_c8383bdf",
        "filename": "adb/client/adb_install.cpp",
        "patchSetId": 3
      },
      "lineNbr": 157,
      "author": {
        "id": 1305591
      },
      "writtenOn": "2018-10-15T12:27:15Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "3aee65c5_f5dc9e4c",
      "range": {
        "startLine": 156,
        "startChar": 17,
        "endLine": 157,
        "endChar": 41
      },
      "revId": "dbcef7e00bce01082f83cc92caf978b78ec86d15",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "95a25496_d559e3c2",
        "filename": "adb/client/adb_install.cpp",
        "patchSetId": 3
      },
      "lineNbr": 164,
      "author": {
        "id": 1003224
      },
      "writtenOn": "2018-10-12T15:38:37Z",
      "side": 1,
      "message": "prefer terminology that you _know_ the user knows. \".apex\" (since that\u0027s what they gave you) and \"--fastdeploy\". (also, the bit after the comma is misleading: it implies you\u0027re doing _something_. just \"--fastdeploy doesn\u0027t support .apex files\" is fine.)",
      "range": {
        "startLine": 164,
        "startChar": 17,
        "endLine": 164,
        "endChar": 90
      },
      "revId": "dbcef7e00bce01082f83cc92caf978b78ec86d15",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "694b17bf_852715a3",
        "filename": "adb/client/adb_install.cpp",
        "patchSetId": 3
      },
      "lineNbr": 164,
      "author": {
        "id": 1305591
      },
      "writtenOn": "2018-10-15T12:27:15Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "95a25496_d559e3c2",
      "range": {
        "startLine": 164,
        "startChar": 17,
        "endLine": 164,
        "endChar": 90
      },
      "revId": "dbcef7e00bce01082f83cc92caf978b78ec86d15",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "ca894b8f_f7630167",
        "filename": "adb/client/adb_install.cpp",
        "patchSetId": 3
      },
      "lineNbr": 210,
      "author": {
        "id": 1003224
      },
      "writtenOn": "2018-10-15T16:03:16Z",
      "side": 1,
      "message": "to be honest, i haven\u0027t really understood this change at all. since you\u0027re only checking the name anyway, why not just let the other side do it? you\u0027re going to have to deal with reporting other kinds of errors back from the other side.\n\nseems like the only change we _need_ on this side is the one that allows .apex files through [in the one case for which they\u0027re actually supported]?",
      "range": {
        "startLine": 208,
        "startChar": 0,
        "endLine": 210,
        "endChar": 9
      },
      "revId": "dbcef7e00bce01082f83cc92caf978b78ec86d15",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "9279db00_f4d49756",
        "filename": "adb/client/adb_install.cpp",
        "patchSetId": 3
      },
      "lineNbr": 210,
      "author": {
        "id": 1305591
      },
      "writtenOn": "2018-10-16T09:53:42Z",
      "side": 1,
      "message": "The streamed install just transfers the bytes without the filename. On PM side, presently, is therefore assumed that the content is an APK. Flags seems to be the common way to characterise the content of the APK: for example I see that they are used for indicating whether an apk being streamed is an instant app or not. In a previous version of this CL I was thinking of having the user specify --apex on the command line, but then I thought that the auto-detection based on file suffix would have resulted in a better user experience.\n\nI could move the APK vs APEX detection on the PM side but that would require some inspection of the package. Note that an APEX has certain characteristics of an APK like the APK signature and a basic XML manifest, but nothing more. I think passing the flag would simplify the logic on the PM side and be consistent with other similar use cases.\n\nSee I3ac7971ce6923511a7d574291fe9002c5d55fa1b internally for the proposed changes to PM.",
      "parentUuid": "ca894b8f_f7630167",
      "range": {
        "startLine": 208,
        "startChar": 0,
        "endLine": 210,
        "endChar": 9
      },
      "revId": "dbcef7e00bce01082f83cc92caf978b78ec86d15",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "648950f8_aac800b1",
        "filename": "adb/client/adb_install.cpp",
        "patchSetId": 3
      },
      "lineNbr": 210,
      "author": {
        "id": 1269249
      },
      "writtenOn": "2018-10-16T11:32:07Z",
      "side": 1,
      "message": "+1 for keeping PM dumb and adb smart. The less that is in PM the more opportunity there is for post-release improvements.",
      "parentUuid": "9279db00_f4d49756",
      "range": {
        "startLine": 208,
        "startChar": 0,
        "endLine": 210,
        "endChar": 9
      },
      "revId": "dbcef7e00bce01082f83cc92caf978b78ec86d15",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "b404a057_3be45509",
        "filename": "adb/client/adb_install.cpp",
        "patchSetId": 3
      },
      "lineNbr": 210,
      "author": {
        "id": 1003224
      },
      "writtenOn": "2018-10-17T00:53:06Z",
      "side": 1,
      "message": "you\u0027d think so, but the opposite is true. there\u0027s only one adb for all OS releases, so if you think the device side might need to change, it\u0027s _really_ helpful for adb to know exactly who it\u0027s talking to, and what they support.\n\nright now, there\u0027s only one OS version that supports apex, so you have exactly the same freedom no matter what we do. it\u0027s _next_ release where you\u0027ll trip up though: at that point the One True adb won\u0027t know what level of apex support the device it\u0027s talking to has. so you may as well add an \"apex\" feature to distinguish apex/non-apex, and then you can add a \"fastapex\" feature or whatever later when there are apex variants you need to worry about.\n\n(and the device\u0027s API level would be a bad proxy for this, because part of the point of apex is to make \"API level\" less meaningful :-) )",
      "parentUuid": "648950f8_aac800b1",
      "range": {
        "startLine": 208,
        "startChar": 0,
        "endLine": 210,
        "endChar": 9
      },
      "revId": "dbcef7e00bce01082f83cc92caf978b78ec86d15",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "a329df32_ede3ac2e",
        "filename": "adb/client/adb_install.cpp",
        "patchSetId": 3
      },
      "lineNbr": 258,
      "author": {
        "id": 1003224
      },
      "writtenOn": "2018-10-12T15:38:37Z",
      "side": 1,
      "message": "should the API level that\u0027s currently in one of the other methods check be moved up into the code that chooses a method instead, and then this can be removed?",
      "range": {
        "startLine": 253,
        "startChar": 0,
        "endLine": 258,
        "endChar": 0
      },
      "revId": "dbcef7e00bce01082f83cc92caf978b78ec86d15",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "540f59a3_6bdc8526",
        "filename": "adb/client/adb_install.cpp",
        "patchSetId": 3
      },
      "lineNbr": 258,
      "author": {
        "id": 1305591
      },
      "writtenOn": "2018-10-15T12:27:15Z",
      "side": 1,
      "message": "I thought about it, I think it would be cumbersome since the argument parsing of filenames is usually deferred to these leaf functions. I can change that if you feel strongly about it.",
      "parentUuid": "a329df32_ede3ac2e",
      "range": {
        "startLine": 253,
        "startChar": 0,
        "endLine": 258,
        "endChar": 0
      },
      "revId": "dbcef7e00bce01082f83cc92caf978b78ec86d15",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "b40f7edb_7ff2556a",
        "filename": "adb/client/adb_install.cpp",
        "patchSetId": 3
      },
      "lineNbr": 404,
      "author": {
        "id": 1003224
      },
      "writtenOn": "2018-10-12T15:38:37Z",
      "side": 1,
      "message": "what\u0027s the error message without this? (when `pm` gets the .apex...)",
      "range": {
        "startLine": 399,
        "startChar": 0,
        "endLine": 404,
        "endChar": 0
      },
      "revId": "dbcef7e00bce01082f83cc92caf978b78ec86d15",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "0f2d176f_abd52e58",
        "filename": "adb/client/adb_install.cpp",
        "patchSetId": 3
      },
      "lineNbr": 404,
      "author": {
        "id": 1305591
      },
      "writtenOn": "2018-10-15T12:27:15Z",
      "side": 1,
      "message": "I think that without this line adb will skip the file and silently stop parsing the other command line arguments.\n\nAssuming that we also accept APEX files (e.g. if we add\n\n|| android::base::EndsWithIgnoreCase(file, \".apex\")\n\nbelow line 405, part of the problem is that in the current implementation there is an install flag (INSTALL_APEX) set for the entire session. So if you attempt to pass the file without setting the flag, the package manager will likely fail at some point when trying to install this as an apk. I can test this behaviour more thoroughly if you want but given that it would require carefully crafting the scenario for failure I\u0027m not sure whether it\u0027s worth covering.",
      "parentUuid": "b40f7edb_7ff2556a",
      "range": {
        "startLine": 399,
        "startChar": 0,
        "endLine": 404,
        "endChar": 0
      },
      "revId": "dbcef7e00bce01082f83cc92caf978b78ec86d15",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    }
  ]
}